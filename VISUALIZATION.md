# ä¿®å¤å‰åå¯¹æ¯”å¯è§†åŒ–

## ä¿®å¤å‰çš„é—®é¢˜

### æ—¶é—´çº¿ç¤ºæ„å›¾ï¼ˆä¿®å¤å‰ï¼‰âŒ

```
1æœˆ1æ—¥          1æœˆ7æ—¥          1æœˆ10æ—¥
  |              |               |
  |              |            [è¿‡æœŸæ—¥æœŸ]
  |              |            â”Œâ”€â”€â”€â”€â”€â”
  |              |            â”‚äº‹ä»¶ â”‚ â† æ—¥å†æ˜¾ç¤ºäº‹ä»¶åœ¨è¿™é‡Œ
  |              |            â””â”€â”€â”€â”€â”€â”˜
  |              â†‘
  |           æé†’è§¦å‘
  |         ï¼ˆå®é™…æé†’æ—¶é—´ï¼‰
  â””â”€ ä»Šå¤©
```

**ç”¨æˆ·ä½“éªŒé—®é¢˜**ï¼š
- âŒ æ‰“å¼€æ—¥å†APPï¼Œåœ¨1æœˆ10æ—¥çœ‹åˆ°äº‹ä»¶"å•†å“å³å°†è¿‡æœŸ"
- âŒ ä½†å®é™…æé†’åœ¨1æœˆ7æ—¥è§¦å‘
- âŒ é€ æˆæ··æ·†ï¼šä¸ºä»€ä¹ˆ10å·çš„äº‹ä»¶è¦åœ¨7å·æé†’ï¼Ÿ

### æ•°æ®æµï¼ˆä¿®å¤å‰ï¼‰

```
AddProductScreen
    â†“
reminderDaysBefore = 3 (å¤©)
    â†“
ProductRepository
    â†“
reminderMinutes = 3 Ã— 24 Ã— 60 = 4320 (åˆ†é’Ÿ) â† ä¸å¿…è¦çš„è½¬æ¢
    â†“
CalendarHelper
    â†“
event.date = expiryDate (1æœˆ10æ—¥) â† âŒ é”™è¯¯ï¼
reminder.minutesBefore = 4320
    â†“
ç³»ç»Ÿæ—¥å†
    â†“
ç»“æœï¼šäº‹ä»¶æ˜¾ç¤ºåœ¨1æœˆ10æ—¥ï¼Œæé†’åœ¨1æœˆ7æ—¥è§¦å‘
```

---

## ä¿®å¤åçš„æ–¹æ¡ˆ

### æ—¶é—´çº¿ç¤ºæ„å›¾ï¼ˆä¿®å¤åï¼‰âœ…

```
1æœˆ1æ—¥          1æœˆ7æ—¥          1æœˆ10æ—¥
  |              |               |
  |           [æé†’æ—¥æœŸ]      [è¿‡æœŸæ—¥æœŸ]
  |           â”Œâ”€â”€â”€â”€â”€â”
  |           â”‚äº‹ä»¶ â”‚ â† æ—¥å†æ˜¾ç¤ºäº‹ä»¶åœ¨è¿™é‡Œ
  |           â””â”€â”€â”€â”€â”€â”˜
  |              â†‘
  |           äº‹ä»¶æ—¥æœŸ
  |           æé†’è§¦å‘æ—¶é—´
  |         ï¼ˆäº‹ä»¶å‰1å°æ—¶ï¼‰
  â””â”€ ä»Šå¤©
```

**ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼š
- âœ… æ‰“å¼€æ—¥å†APPï¼Œåœ¨1æœˆ7æ—¥çœ‹åˆ°äº‹ä»¶"å•†å“å°†åœ¨3å¤©åè¿‡æœŸ"
- âœ… æé†’ä¹Ÿåœ¨1æœˆ7æ—¥è§¦å‘ï¼ˆäº‹ä»¶å‰1å°æ—¶ï¼‰
- âœ… æ¸…æ™°ç›´è§‚ï¼š7å·æé†’ï¼Œå‘ŠçŸ¥3å¤©åè¿‡æœŸ

### æ•°æ®æµï¼ˆä¿®å¤åï¼‰

```
AddProductScreen
    â†“
reminderDaysBefore = 3 (å¤©)
    â†“
ProductRepository
    â†“
reminderDaysBefore = 3 (ç›´æ¥ä¼ é€’) â† âœ… ä¿æŒè¯­ä¹‰æ¸…æ™°
    â†“
CalendarHelper
    â†“
reminderDate = expiryDate - (3 Ã— 24 Ã— 60 Ã— 60 Ã— 1000) â† âœ… æ­£ç¡®è®¡ç®—
            = 1æœˆ10æ—¥ - 3å¤© = 1æœˆ7æ—¥
    â†“
event.date = reminderDate (1æœˆ7æ—¥) â† âœ… æ­£ç¡®ï¼
event.title = "â° å•†å“ å°†åœ¨3å¤©åè¿‡æœŸ"
reminder.minutesBefore = 60 (äº‹ä»¶å‰1å°æ—¶)
    â†“
ç³»ç»Ÿæ—¥å†
    â†“
ç»“æœï¼šäº‹ä»¶æ˜¾ç¤ºåœ¨1æœˆ7æ—¥ï¼Œæ ‡é¢˜æ¸…æ¥šè¯´æ˜"3å¤©åè¿‡æœŸ"
```

---

## æé†’æ–¹å¼å¤„ç†

### ä¿®å¤å‰âŒ

```
ç”¨æˆ·é€‰æ‹©æé†’æ–¹å¼
    â†“
reminderMethod = "ALARM"
    â†“
CalendarHelper.addReminderToEvent()
    â†“
contentResolver.insert(...)  â† âŒ æ²¡æœ‰æ£€æŸ¥è¿”å›å€¼
    â†“
ï¼ˆå¦‚æœå¤±è´¥ï¼Œæ— æ—¥å¿—ï¼Œæ— æ³•è¿½è¸ªï¼‰
```

### ä¿®å¤åâœ…

```
ç”¨æˆ·é€‰æ‹©æé†’æ–¹å¼
    â†“
reminderMethod = "ALARM"
    â†“
CalendarHelper.addReminderToEvent()
    â†“
method = when(reminderMethod.uppercase()) {
    "ALARM" -> METHOD_ALARM (4)
    "NOTIFICATION" -> METHOD_ALERT (1)
}
    â†“
Log: "æ·»åŠ æé†’ - æé†’æ–¹å¼: ALARM (æ–¹æ³•å€¼: 4)"  â† âœ… è¯¦ç»†æ—¥å¿—
    â†“
uri = contentResolver.insert(...)
success = uri != null  â† âœ… æ£€æŸ¥è¿”å›å€¼
    â†“
if (success) {
    Log: "æé†’æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ–¹å¼: é—¹é’Ÿ"  â† âœ… æˆåŠŸæ—¥å¿—
} else {
    Log: "æé†’æ·»åŠ å¤±è´¥ï¼Œinsertè¿”å›null"  â† âœ… å¤±è´¥æ—¥å¿—
}
    â†“
return success  â† âœ… è¿”å›çŠ¶æ€
```

---

## å®ä¾‹å¯¹æ¯”

### åœºæ™¯ï¼šæ·»åŠ ç‰›å¥¶ï¼Œè¿‡æœŸæ—¥æœŸ2024-01-10ï¼Œæå‰3å¤©æé†’

#### ä¿®å¤å‰âŒ

| é¡¹ç›® | å€¼ | ç”¨æˆ·çœ‹åˆ°çš„ |
|------|-----|-----------|
| æ—¥å†äº‹ä»¶æ—¥æœŸ | 2024-01-10 | "1æœˆ10æ—¥æœ‰äº‹ä»¶" |
| äº‹ä»¶æ ‡é¢˜ | "â° ç‰›å¥¶ å³å°†è¿‡æœŸ" | ä¸çŸ¥é“è¿˜æœ‰å‡ å¤© |
| æé†’æ—¶é—´ | 2024-01-07 | æ”¶åˆ°æé†’ï¼ˆä½†æ—¥å†äº‹ä»¶åœ¨10å·ï¼‰ |
| ç”¨æˆ·å›°æƒ‘ | âš ï¸ | "ä¸ºä»€ä¹ˆ10å·çš„äº‹ä»¶7å·å°±æé†’ï¼Ÿ" |

#### ä¿®å¤åâœ…

| é¡¹ç›® | å€¼ | ç”¨æˆ·çœ‹åˆ°çš„ |
|------|-----|-----------|
| æ—¥å†äº‹ä»¶æ—¥æœŸ | 2024-01-07 | "1æœˆ7æ—¥æœ‰äº‹ä»¶" âœ… |
| äº‹ä»¶æ ‡é¢˜ | "â° ç‰›å¥¶ å°†åœ¨3å¤©åè¿‡æœŸ" | æ¸…æ¥šçŸ¥é“3å¤©åè¿‡æœŸ âœ… |
| æé†’æ—¶é—´ | 2024-01-07 ä¸Šåˆ | æ”¶åˆ°æé†’ï¼ˆä¸äº‹ä»¶æ—¥æœŸä¸€è‡´ï¼‰ âœ… |
| ç”¨æˆ·ä½“éªŒ | ğŸ‘ | "7å·æé†’æˆ‘ï¼Œ3å¤©åè¿‡æœŸï¼Œå®Œç¾ï¼" |

---

## æ—¥å¿—å¯¹æ¯”

### ä¿®å¤å‰ï¼ˆæ— æ—¥å¿—ï¼‰âŒ

```
ï¼ˆé™é»˜è¿è¡Œï¼Œå‡ºé”™ä¹Ÿä¸çŸ¥é“ï¼‰
```

### ä¿®å¤åï¼ˆå®Œæ•´æ—¥å¿—ï¼‰âœ…

```
D/CalendarHelper: æ—¥å†äº‹ä»¶åˆ›å»ºæˆåŠŸï¼Œäº‹ä»¶ID: 12345
D/CalendarHelper: æ·»åŠ æé†’ - äº‹ä»¶ID: 12345, æé†’æ–¹å¼: ALARM (æ–¹æ³•å€¼: 4), æå‰æ—¶é—´: 60åˆ†é’Ÿ
D/CalendarHelper: æé†’æ·»åŠ æˆåŠŸï¼Œä½¿ç”¨æ–¹å¼: é—¹é’Ÿ
```

å¦‚æœå‡ºé”™ï¼š
```
E/CalendarHelper: æ— æ³•è·å–æ—¥å†IDï¼Œè¯·ç¡®ä¿å·²æˆäºˆæ—¥å†æƒé™
```

æˆ–è€…ï¼š
```
E/CalendarHelper: æ·»åŠ æé†’å¤±è´¥ï¼Œä½†äº‹ä»¶å·²åˆ›å»º
E/CalendarHelper: æ·»åŠ æé†’æ—¶å‡ºé”™: Permission denied
```

---

## å…³é”®ä»£ç å¯¹æ¯”

### æ—¥æœŸè®¡ç®—

```kotlin
// ä¿®å¤å‰âŒ
val values = ContentValues().apply {
    put(CalendarContract.Events.DTSTART, expiryDate)  // äº‹ä»¶åœ¨è¿‡æœŸæ—¥æœŸ
}

// ä¿®å¤åâœ…
val reminderDate = expiryDate - (reminderDaysBefore * 24 * 60 * 60 * 1000L)
val values = ContentValues().apply {
    put(CalendarContract.Events.DTSTART, reminderDate)  // äº‹ä»¶åœ¨æé†’æ—¥æœŸ
}
```

### å‚æ•°ä¼ é€’

```kotlin
// ä¿®å¤å‰âŒ
val reminderMinutes = product.reminderDaysBefore * 24 * 60  // è½¬æ¢ä¸ºåˆ†é’Ÿ
CalendarHelper.addEventToCalendar(..., reminderMinutes, ...)

// ä¿®å¤åâœ…
CalendarHelper.addEventToCalendar(..., product.reminderDaysBefore, ...)  // ç›´æ¥ä¼ å¤©æ•°
```

### é”™è¯¯å¤„ç†

```kotlin
// ä¿®å¤å‰âŒ
contentResolver.insert(CalendarContract.Reminders.CONTENT_URI, reminderValues)
// æ²¡æœ‰æ£€æŸ¥ï¼Œæ²¡æœ‰æ—¥å¿—

// ä¿®å¤åâœ…
val uri = contentResolver.insert(CalendarContract.Reminders.CONTENT_URI, reminderValues)
val success = uri != null
if (success) {
    Log.d(TAG, "æé†’æ·»åŠ æˆåŠŸ")
} else {
    Log.e(TAG, "æé†’æ·»åŠ å¤±è´¥")
}
return success
```

---

## æ€»ç»“

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æ—¥å†äº‹ä»¶ä½ç½® | âŒ è¿‡æœŸæ—¥æœŸ | âœ… æé†’æ—¥æœŸ |
| äº‹ä»¶æ ‡é¢˜ | âŒ "å³å°†è¿‡æœŸ" | âœ… "å°†åœ¨Xå¤©åè¿‡æœŸ" |
| ç”¨æˆ·ä½“éªŒ | âŒ æ··æ·† | âœ… æ¸…æ™° |
| é”™è¯¯å¤„ç† | âŒ æ—  | âœ… å®Œæ•´ |
| æ—¥å¿—è®°å½• | âŒ æ—  | âœ… è¯¦ç»† |
| å¯ç»´æŠ¤æ€§ | âŒ éš¾ä»¥è°ƒè¯• | âœ… æ˜“äºè¿½è¸ª |
| ä»£ç æ¸…æ™°åº¦ | âŒ å‚æ•°è½¬æ¢ | âœ… è¯­ä¹‰ç›´è§‚ |
